<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nuro AI</title>
  <style>
    :root{
      --bg:#070812;
      --panel:#0f1118cc;
      --card:#0d0f15;
      --line:#24283a;
      --line2:#343a55;
      --text:#e9eaf2;
      --muted:#a7abc2;
      --accent1:#4f46e5;
      --accent2:#22d3ee;
      --accent3:#a855f7;
      --radius:18px;
    }
    *{ box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body{
      margin:0; min-height:100vh; color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 15%, #4f46e533, transparent 60%),
        radial-gradient(900px 500px at 85% 20%, #22d3ee22, transparent 55%),
        radial-gradient(900px 600px at 70% 85%, #a855f722, transparent 55%),
        var(--bg);
    }
    .app{ display:grid; grid-template-columns: 280px 1fr; min-height:100vh; }
    @media (max-width: 980px){ .app{ grid-template-columns: 1fr; } .sidebar{ position:sticky; top:0; z-index:5; } }

    .sidebar{
      border-right:1px solid var(--line);
      background: linear-gradient(180deg, #0b0d14cc, #090a0fcc);
      backdrop-filter: blur(10px);
      padding:18px;
      display:flex; flex-direction:column; gap:14px;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      padding:10px; border:1px solid var(--line);
      border-radius: var(--radius);
      background: #0b0d14aa;
    }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, var(--accent1), var(--accent2), var(--accent3));
      box-shadow: 0 0 24px #4f46e533;
      flex:0 0 auto;
    }
    .brand h1{ margin:0; font-size:18px; letter-spacing:0.2px; }
    .brand .tag{ margin-top:2px; color:var(--muted); font-size:12px; }

    .nav{ display:flex; flex-direction:column; gap:8px; margin-top:6px; }
    .navbtn{
      border:1px solid transparent;
      background: transparent;
      color:var(--text);
      padding:12px;
      border-radius: 14px;
      cursor:pointer;
      text-align:left;
      display:flex; align-items:center; gap:10px;
    }
    .navbtn:hover{ background:#0f1118; border-color: var(--line); }
    .navbtn.active{
      background:#0f1118;
      border-color:var(--line2);
      box-shadow: 0 0 0 2px #343a5533 inset;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: #8b8fa7; }

    .upgrade{
      margin-top:auto;
      border:1px solid #3b3b55;
      background: linear-gradient(135deg, var(--accent1), var(--accent2), var(--accent3));
      color:#0b0d14;
      font-weight:900;
      padding:12px;
      border-radius: 14px;
      cursor:pointer;
    }
    .profile{
      display:flex; gap:10px; align-items:center;
      padding-top:10px; border-top:1px solid var(--line);
      color:var(--muted); font-size:13px;
    }
    .avatar{
      width:36px; height:36px; border-radius:999px;
      background:#171a28; border:1px solid var(--line);
      display:flex; align-items:center; justify-content:center;
      color:#cbd5ff; font-weight:900;
    }

    .main{ padding:22px; }
    .topbar{
      display:flex; justify-content:space-between; align-items:center; gap:14px; flex-wrap:wrap;
      margin-bottom:16px;
    }
    .title h2{ margin:0; font-size:44px; letter-spacing:0.2px; }
    .title .sub{ margin-top:6px; color:var(--muted); }

    .search{
      min-width:260px; width:420px; max-width:100%;
      display:flex; gap:8px; align-items:center;
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px 12px;
      background: #0f1118cc;
      backdrop-filter: blur(10px);
    }
    .search input{
      width:100%;
      border:none; outline:none;
      background:transparent; color:var(--text);
      font-size:14px;
    }
    .kbd{
      color:var(--muted); font-size:12px;
      border:1px solid var(--line);
      padding:4px 8px;
      border-radius:10px;
      background:#0d0f15;
    }

    .panel{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
      backdrop-filter: blur(10px);
      padding:16px;
    }

    .cards{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 1100px){ .cards{ grid-template-columns: 1fr 1fr; } }
    @media (max-width: 650px){ .cards{ grid-template-columns: 1fr; } }

    .cardbtn{
      border:1px solid var(--line);
      background: #0d0f15;
      border-radius: 16px;
      padding:14px;
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      transition: transform .05s ease;
    }
    .cardbtn:hover{ border-color:#3b3b55; }
    .cardbtn:active{ transform: translateY(1px); }
    .cardleft{ display:flex; gap:12px; align-items:center; }
    .icon{
      width:38px; height:38px; border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      background: #151a2a;
      border:1px solid #2a2f48;
      color:#c7cbff;
      font-weight:900;
    }
    .cardbtn strong{ display:block; font-size:14px; }
    .cardbtn span{ display:block; margin-top:2px; color:var(--muted); font-size:12px; }
    .arrow{ color:var(--muted); font-size:18px; }

    .notesHead{
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;
      margin-top:14px;
    }
    .tabs{ display:flex; gap:8px; align-items:center; }
    .tab{
      border:1px solid var(--line);
      background:#0d0f15;
      color:var(--text);
      padding:8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size:13px;
    }
    .tab.active{ border-color:#3b3b55; box-shadow: 0 0 0 2px #3b3b5533 inset; }

    .ghost{
      border:1px solid var(--line);
      background:#0d0f15;
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-size:13px;
    }
    .ghost:hover{ border-color:#3b3b55; }

    .list{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }
    .noteItem{
      border:1px solid var(--line);
      background:#0d0f15;
      border-radius: 16px;
      padding:14px;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
    }
    .noteItem:hover{ border-color:#3b3b55; }
    .noteMeta strong{ display:block; font-size:14px; }
    .noteMeta .muted{ margin-top:4px; color:var(--muted); font-size:12px; }
    .btnrow{ display:flex; gap:10px; align-items:center; }

    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.55);
      display:none; align-items:center; justify-content:center;
      padding:18px; z-index:50;
    }
    .modal{
      width:min(980px, 100%);
      border:1px solid var(--line);
      border-radius: 18px;
      background: #0b0d14f2;
      backdrop-filter: blur(12px);
      padding:16px;
    }
    .modalTop{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .close{
      border:1px solid var(--line);
      background:#0d0f15;
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
    }
    input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      background:#0d0f15;
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      outline:none;
    }
    textarea{ min-height:300px; resize:vertical; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .primary{
      border:none;
      background: linear-gradient(135deg, var(--accent1), var(--accent2), var(--accent3));
      color:#0b0d14;
      font-weight:950;
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
    }
    .hint{ color:var(--muted); font-size:12px; margin-top:10px; line-height:1.4; }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
    @media (max-width: 860px){ .grid2{ grid-template-columns: 1fr; } }
    .setCard{
      border:1px solid var(--line);
      background:#0d0f15;
      border-radius:16px;
      padding:14px;
      display:flex; justify-content:space-between; gap:12px; align-items:flex-start;
    }
    .studyCard{
      border:1px solid var(--line);
      background:#0d0f15;
      border-radius:18px;
      padding:18px;
      min-height:220px;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      justify-content:center;
      text-align:center;
      cursor:pointer;
      user-select:none;
      margin-top:12px;
    }
    .faceTag{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:4px 10px;
      border-radius:999px;
      background:#0b0d14;
    }
    .faceText{
      font-size:16px;
      line-height:1.45;
      white-space:pre-wrap;
    }

    .toast{
      position:fixed; bottom:18px; right:18px;
      background:#0d0f15; border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px; border-radius:12px;
      display:none; z-index:60; max-width: 420px;
    }
    .toast small{ color:var(--muted); }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Nuro AI</h1>
          <div class="tag">Study Smarter. Level Faster.</div>
        </div>
      </div>

      <div class="nav">
        <button class="navbtn active" id="navDash" onclick="setPage('dashboard')"><span class="dot"></span> Dashboard</button>
        <button class="navbtn" id="navFlash" onclick="setPage('flash')"><span class="dot"></span> Flashcards</button>
        <button class="navbtn" id="navTests" onclick="setPage('tests')"><span class="dot"></span> Practice Tests</button>
        <button class="navbtn" id="navGuides" onclick="setPage('guides')"><span class="dot"></span> Study Guides</button>
        <button class="navbtn" id="navSettings" onclick="setPage('settings')"><span class="dot"></span> Settings</button>
      </div>

      <button class="upgrade" onclick="toast('Premium later','We‚Äôll add pricing after core features are solid.')">‚ú® Upgrade to Premium</button>

      <div class="profile">
        <div class="avatar">N</div>
        <div>
          <div style="color:var(--text); font-weight:900;">nuro user</div>
          <div>local mode</div>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title">
          <h2 id="pageTitle">Dashboard</h2>
          <div class="sub" id="pageSub">Create new notes</div>
        </div>

        <div class="search">
          <input id="searchInput" placeholder="Search (Ctrl/‚åò + K)" oninput="renderNotes()" />
          <div class="kbd">‚åò K</div>
        </div>
      </div>

      <section id="page_dashboard" class="panel">
        <div class="cards">
          <div class="cardbtn" onclick="newBlankDoc()">
            <div class="cardleft">
              <div class="icon">üìù</div>
              <div>
                <strong>Blank document</strong>
                <span>Start from scratch</span>
              </div>
            </div>
            <div class="arrow">‚Ä∫</div>
          </div>

          <div class="cardbtn" onclick="openModal('audio')">
            <div class="cardleft">
              <div class="icon">üéôÔ∏è</div>
              <div>
                <strong>Audio upload</strong>
                <span>(placeholder)</span>
              </div>
            </div>
            <div class="arrow">‚Ä∫</div>
          </div>

          <div class="cardbtn" onclick="openModal('doc')">
            <div class="cardleft">
              <div class="icon">üìÑ</div>
              <div>
                <strong>Document upload</strong>
                <span>(UI first)</span>
              </div>
            </div>
            <div class="arrow">‚Ä∫</div>
          </div>

          <div class="cardbtn" onclick="openModal('link')">
            <div class="cardleft">
              <div class="icon">üîó</div>
              <div>
                <strong>Website link</strong>
                <span>YouTube or website</span>
              </div>
            </div>
            <div class="arrow">‚Ä∫</div>
          </div>
        </div>

        <div class="notesHead">
          <div class="tabs">
            <button class="tab active" id="tabMy" onclick="setNotesTab('my')">My Notes</button>
            <button class="tab" id="tabShared" onclick="setNotesTab('shared')">Shared with Me</button>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="ghost" onclick="newBlankDoc()">Ôºã New Note</button>
          </div>
        </div>

        <div class="list" id="notesList"></div>
      </section>

      <section id="page_flash" class="panel" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div>
            <h3 style="margin:0 0 6px;">Flashcards</h3>
            <div style="color:var(--muted); font-size:13px;">Now splits paragraphs into many cards.</div>
          </div>
          <button class="ghost" onclick="openModal('import')">‚ú® Create from Notes</button>
        </div>
        <div id="flashRoot"></div>
      </section>

      <section id="page_tests" class="panel" style="display:none;">
        <h3 style="margin:0 0 6px;">Practice Tests</h3>
        <div style="color:var(--muted); font-size:13px;">Coming next</div>
        <div class="list" id="testsList"></div>
      </section>

      <section id="page_guides" class="panel" style="display:none;">
        <h3 style="margin:0 0 6px;">Study Guides</h3>
        <div style="color:var(--muted); font-size:13px;">Coming next</div>
      </section>

      <section id="page_settings" class="panel" style="display:none;">
        <h3 style="margin:0 0 6px;">Settings</h3>
        <div class="row">
          <button class="ghost" onclick="exportAll()">‚¨áÔ∏è Export Data</button>
          <button class="ghost" onclick="importAll()">‚¨ÜÔ∏è Import Data</button>
          <button class="ghost" onclick="resetAll()">üóëÔ∏è Reset All</button>
        </div>
      </section>
    </main>
  </div>

  <!-- NOTE EDITOR -->
  <div class="overlay" id="modal_note">
    <div class="modal">
      <div class="modalTop">
        <div style="flex:1;"><input id="noteTitle" placeholder="Note title..." /></div>
        <button class="close" onclick="closeModal('note')">Close</button>
      </div>
      <textarea id="noteBody" placeholder="Write your notes here..."></textarea>
      <div class="row">
        <button class="primary" onclick="saveNote()">Save</button>
        <button class="ghost" onclick="openFromNoteToImport()">‚ú® Generate Flashcards</button>
      </div>
      <div class="hint">
        Tip: If your notes are one big paragraph, we‚Äôll split it into multiple cards automatically.
      </div>
    </div>
  </div>

  <!-- LINK MODAL -->
  <div class="overlay" id="modal_link">
    <div class="modal">
      <div class="modalTop">
        <div style="flex:1; font-weight:900;">Add website link</div>
        <button class="close" onclick="closeModal('link')">Close</button>
      </div>
      <div class="row">
        <div style="flex:1; min-width:240px;">
          <label style="color:var(--muted); font-size:13px;">Title</label>
          <input id="linkTitle" placeholder="e.g., Biology Crash Course" />
        </div>
        <div style="flex:1; min-width:240px;">
          <label style="color:var(--muted); font-size:13px;">URL</label>
          <input id="linkUrl" placeholder="https://..." />
        </div>
      </div>
      <div class="row">
        <button class="primary" onclick="saveLink()">Save link</button>
      </div>
    </div>
  </div>

  <!-- DOC MODAL -->
  <div class="overlay" id="modal_doc">
    <div class="modal">
      <div class="modalTop">
        <div style="flex:1; font-weight:900;">Document upload (UI)</div>
        <button class="close" onclick="closeModal('doc')">Close</button>
      </div>
      <input type="file" id="docFile" />
      <div class="row">
        <button class="primary" onclick="saveDocMeta()">Save document</button>
      </div>
    </div>
  </div>

  <!-- AUDIO MODAL -->
  <div class="overlay" id="modal_audio">
    <div class="modal">
      <div class="modalTop">
        <div style="flex:1; font-weight:900;">Audio upload</div>
        <button class="close" onclick="closeModal('audio')">Close</button>
      </div>
      <input type="file" id="audioFile" accept="audio/*" />
      <div class="row">
        <button class="primary" onclick="saveAudioMeta()">Save audio</button>
      </div>
    </div>
  </div>

  <!-- IMPORT FLASHCARDS -->
  <div class="overlay" id="modal_import">
    <div class="modal">
      <div class="modalTop">
        <div style="flex:1; font-weight:950;">Create flashcards from notes</div>
        <button class="close" onclick="closeModal('import')">Close</button>
      </div>

      <div class="row">
        <div style="flex:1; min-width:240px;">
          <label style="color:var(--muted); font-size:13px;">Set name</label>
          <input id="impSetName" placeholder="e.g., Biology Unit 3" />
        </div>
        <div style="flex:1; min-width:240px;">
          <label style="color:var(--muted); font-size:13px;">Max cards</label>
          <select id="impMax">
            <option>10</option><option selected>20</option><option>30</option><option>50</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label style="color:var(--muted); font-size:13px;">Paste notes</label>
        <textarea id="impText" placeholder="Paste your notes here..."></textarea>
      </div>

      <div class="row">
        <button class="primary" onclick="importFlashcards()">Generate</button>
      </div>

      <div class="hint">
        Works with: new lines, bullets, Term - definition, Q/A, or even big paragraphs.
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const NOTES_KEY = "nuro_notes_v5";
    const FLASH_KEY = "nuro_flash_v5";

    let notesState = loadNotes();
    let flashState = loadFlash();
    let openNoteId = null;

    function nid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

    function loadNotes(){
      const raw = localStorage.getItem(NOTES_KEY);
      if(raw) return JSON.parse(raw);
      return {
        notesTab: "my",
        notes: [
          { id:nid(), type:"note", title:"Bio (paste anything)", updatedAt:Date.now()-86400000, body:
`Cell membrane - Controls what enters and leaves the cell.
Mitochondria - Produces ATP (energy).
Osmosis is the diffusion of water across a membrane from high water concentration to low water concentration.
Enzymes speed up reactions and can denature with temperature or pH changes.`}
        ]
      };
    }
    function saveNotes(){ localStorage.setItem(NOTES_KEY, JSON.stringify(notesState)); }

    function loadFlash(){
      const raw = localStorage.getItem(FLASH_KEY);
      if(raw) return JSON.parse(raw);
      return { sets: [], study:{ setId:null, index:0, showBack:false } };
    }
    function saveFlash(){ localStorage.setItem(FLASH_KEY, JSON.stringify(flashState)); }

    function setPage(next){
      document.getElementById("navDash").classList.toggle("active", next==="dashboard");
      document.getElementById("navFlash").classList.toggle("active", next==="flash");
      document.getElementById("navTests").classList.toggle("active", next==="tests");
      document.getElementById("navGuides").classList.toggle("active", next==="guides");
      document.getElementById("navSettings").classList.toggle("active", next==="settings");

      show("page_dashboard", next==="dashboard");
      show("page_flash", next==="flash");
      show("page_tests", next==="tests");
      show("page_guides", next==="guides");
      show("page_settings", next==="settings");

      if(next==="flash") renderFlash();
    }
    function show(id, on){ document.getElementById(id).style.display = on ? "" : "none"; }

    function setNotesTab(which){
      notesState.notesTab = which;
      saveNotes();
      document.getElementById("tabMy").classList.toggle("active", which==="my");
      document.getElementById("tabShared").classList.toggle("active", which==="shared");
      renderNotes();
    }

    function renderNotes(){
      const list = document.getElementById("notesList");
      if(notesState.notesTab === "shared"){
        list.innerHTML = `<div style="color:var(--muted); font-size:13px;">Sharing later.</div>`;
        return;
      }
      const q = (document.getElementById("searchInput").value || "").trim().toLowerCase();
      const items = notesState.notes.slice().sort((a,b)=>b.updatedAt-a.updatedAt).filter(n=>{
        const blob = `${n.title||""} ${n.body||""}`.toLowerCase();
        return q ? blob.includes(q) : true;
      });

      list.innerHTML = items.map(n=>`
        <div class="noteItem">
          <div class="noteMeta">
            <strong>üìù ${safe(n.title||"Untitled")}</strong>
            <div class="muted">Updated ${timeAgo(n.updatedAt)}</div>
          </div>
          <div class="btnrow">
            <button class="ghost" onclick="openItem('${n.id}')">Open</button>
            <button class="ghost" onclick="deleteItem('${n.id}')">Delete</button>
          </div>
        </div>
      `).join("");
    }

    function newBlankDoc(){
      const n = { id:nid(), type:"note", title:"Untitled note", updatedAt:Date.now(), body:"" };
      notesState.notes.unshift(n);
      saveNotes();
      openItem(n.id);
      renderNotes();
    }

    function openItem(id){
      const n = notesState.notes.find(x=>x.id===id);
      if(!n) return;
      openNoteId = id;
      noteTitle.value = n.title||"";
      noteBody.value = n.body||"";
      openModal("note");
    }

    function saveNote(){
      const n = notesState.notes.find(x=>x.id===openNoteId);
      if(!n) return;
      n.title = (noteTitle.value||"").trim() || "Untitled note";
      n.body = (noteBody.value||"").trim();
      n.updatedAt = Date.now();
      saveNotes();
      toast("Saved", "Note saved.");
      renderNotes();
    }

    function deleteItem(id){
      if(!confirm("Delete this note?")) return;
      notesState.notes = notesState.notes.filter(x=>x.id!==id);
      saveNotes();
      renderNotes();
    }

    function openModal(name){ document.getElementById("modal_"+name).style.display="flex"; }
    function closeModal(name){ document.getElementById("modal_"+name).style.display="none"; }

    function openFromNoteToImport(){
      const n = notesState.notes.find(x=>x.id===openNoteId);
      if(!n) return;
      closeModal("note");
      impSetName.value = n.title || "Flashcards";
      impText.value = n.body || "";
      openModal("import");
    }

    // ----------- NEW: strong splitter -----------
    function splitIntoItems(raw){
      let t = (raw||"").replace(/\r/g,"").trim();
      if(!t) return [];

      // Normalize bullets to new lines
      t = t.replace(/[‚Ä¢¬∑]/g, "\n‚Ä¢ ");
      // If it‚Äôs one giant paragraph, split into sentences
      if(!t.includes("\n") && t.length > 120){
        t = t
          .replace(/([.!?])\s+/g, "$1\n")
          .replace(/;\s+/g, ";\n");
      }

      // Also split by new lines
      let lines = t.split("\n").map(s=>s.trim()).filter(Boolean);

      // If still too few lines but has many sentences, split more
      if(lines.length < 4 && t.length > 180){
        lines = t.split(/(?<=[.!?])\s+/g).map(s=>s.trim()).filter(Boolean);
      }

      // Clean bullet prefixes
      lines = lines.map(l=>l.replace(/^[-‚Ä¢*]\s+/,"").trim()).filter(Boolean);

      // Remove super-short junk
      lines = lines.filter(l=>l.length >= 8);

      return lines;
    }

    function importFlashcards(){
      const name = (impSetName.value||"").trim() || "Flashcards";
      const maxCards = parseInt(impMax.value,10);
      const text = (impText.value||"").trim();
      if(!text){ alert("Paste notes first."); return; }

      const items = splitIntoItems(text);
      const cards = items.map(makeCardFromLine).slice(0, maxCards);

      if(cards.length < 2){
        alert("Still only made 1 card. Your notes might be 1 short sentence. Add more lines/sentences.");
        return;
      }

      flashState.sets.unshift({ id:nid(), name, createdAt:Date.now(), cards });
      saveFlash();
      closeModal("import");
      toast("Flashcards created", `Generated ${cards.length} cards`);
      setPage("flash");
    }

    function makeCardFromLine(line){
      // If "Term - definition"
      const m = line.match(/^(.+?)\s*[-‚Äì‚Äî:]\s*(.+)$/);
      if(m){
        return { front: m[1].trim(), back: m[2].trim() };
      }
      // Otherwise: front short, back full
      return { front: shorten(line, 60), back: line };
    }

    function renderFlash(){
      const root = document.getElementById("flashRoot");
      const study = flashState.study || { setId:null, index:0, showBack:false };

      if(study.setId){
        const set = flashState.sets.find(s=>s.id===study.setId);
        if(!set){ flashState.study={setId:null,index:0,showBack:false}; saveFlash(); renderFlash(); return; }
        const c = set.cards[study.index];
        const isBack = !!study.showBack;
        root.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <div>
              <div style="font-weight:950; font-size:16px;">Study: ${safe(set.name)}</div>
              <div style="color:var(--muted); font-size:13px;">${study.index+1} / ${set.cards.length}</div>
            </div>
            <div class="btnrow">
              <button class="ghost" onclick="exitStudy()">Exit</button>
            </div>
          </div>

          <div class="studyCard" onclick="flipStudy()">
            <div class="faceTag">${isBack ? "BACK (Explanation)" : "FRONT (Prompt)"}</div>
            <div class="faceText">${safe(isBack ? c.back : c.front)}</div>
          </div>

          <div class="row">
            <button class="ghost" onclick="flipStudy()">${isBack ? "Hide answer" : "Show answer"}</button>
            <button class="ghost" onclick="nextStudy()">Next</button>
          </div>
        `;
        return;
      }

      if(flashState.sets.length===0){
        root.innerHTML = `<div style="margin-top:12px; color:var(--muted); font-size:13px;">No sets yet.</div>`;
        return;
      }

      root.innerHTML = `
        <div class="grid2">
          ${flashState.sets.map(s=>`
            <div class="setCard">
              <div>
                <div style="font-weight:950;">${safe(s.name)}</div>
                <div style="color:var(--muted); font-size:12px; margin-top:4px;">${s.cards.length} cards ‚Ä¢ created ${timeAgo(s.createdAt)}</div>
              </div>
              <div class="btnrow">
                <button class="ghost" onclick="startStudy('${s.id}')">Study</button>
                <button class="ghost" onclick="deleteSet('${s.id}')">Delete</button>
              </div>
            </div>
          `).join("")}
        </div>
      `;
    }

    function startStudy(setId){
      flashState.study = { setId, index:0, showBack:false };
      saveFlash(); renderFlash();
    }
    function exitStudy(){ flashState.study={setId:null,index:0,showBack:false}; saveFlash(); renderFlash(); }
    function flipStudy(){ flashState.study.showBack = !flashState.study.showBack; saveFlash(); renderFlash(); }
    function nextStudy(){
      const set = flashState.sets.find(s=>s.id===flashState.study.setId);
      if(!set) return;
      flashState.study.index = (flashState.study.index+1) % set.cards.length;
      flashState.study.showBack=false;
      saveFlash(); renderFlash();
    }
    function deleteSet(id){
      if(!confirm("Delete this set?")) return;
      flashState.sets = flashState.sets.filter(s=>s.id!==id);
      flashState.study = { setId:null, index:0, showBack:false };
      saveFlash(); renderFlash();
    }

    function exportAll(){
      const payload = { notesState, flashState };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "nuro-ai-export.json";
      a.click();
      URL.revokeObjectURL(url);
      toast("Exported","Downloaded your data.");
    }
    function importAll(){
      const input = document.createElement("input");
      input.type="file";
      input.accept="application/json";
      input.onchange=()=>{
        const f=input.files[0];
        if(!f) return;
        const r=new FileReader();
        r.onload=()=>{
          try{
            const p=JSON.parse(r.result);
            notesState=p.notesState||notesState;
            flashState=p.flashState||flashState;
            saveNotes(); saveFlash();
            toast("Imported","Data loaded.");
            renderNotes(); renderFlash();
            setPage("dashboard");
          }catch(e){ alert("Invalid JSON."); }
        };
        r.readAsText(f);
      };
      input.click();
    }
    function resetAll(){
      if(!confirm("Delete ALL local data?")) return;
      localStorage.removeItem(NOTES_KEY);
      localStorage.removeItem(FLASH_KEY);
      notesState = loadNotes();
      flashState = loadFlash();
      toast("Reset","All data cleared.");
      renderNotes(); renderFlash();
      setPage("dashboard");
    }

    function safe(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function timeAgo(ts){
      const d = Date.now()-ts;
      const m = Math.floor(d/60000);
      if(m<60) return `${m} min ago`;
      const h = Math.floor(m/60);
      if(h<24) return `${h} hours ago`;
      const days = Math.floor(h/24);
      return `${days} days ago`;
    }
    function toast(title, msg=""){
      const t=document.getElementById("toast");
      t.innerHTML = `<div style="font-weight:950;">${safe(title)}</div><small>${safe(msg)}</small>`;
      t.style.display="block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>t.style.display="none", 2600);
    }
    function shorten(s, n){
      s = String(s).trim();
      if(s.length <= n) return s;
      return s.slice(0, n).trim() + "‚Ä¶";
    }

    document.addEventListener("keydown",(e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="k"){
        e.preventDefault();
        document.getElementById("searchInput").focus();
      }
      if(e.key==="Escape"){
        ["note","link","doc","audio","import"].forEach(n=>{
          const el=document.getElementById("modal_"+n);
          if(el && el.style.display==="flex") el.style.display="none";
        });
      }
    });

    // Boot
    setNotesTab(notesState.notesTab || "my");
    renderNotes();
    renderFlash();
  </script>
</body>
</html>
